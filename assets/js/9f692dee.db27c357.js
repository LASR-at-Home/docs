"use strict";(self.webpackChunkweb=self.webpackChunkweb||[]).push([[934],{3905:(e,t,a)=>{a.d(t,{Zo:()=>s,kt:()=>k});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var p=n.createContext({}),d=function(e){var t=n.useContext(p),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},s=function(e){var t=d(e.components);return n.createElement(p.Provider,{value:t},e.children)},c="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,p=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),c=d(a),m=r,k=c["".concat(p,".").concat(m)]||c[m]||u[m]||i;return a?n.createElement(k,o(o({ref:t},s),{},{components:a})):n.createElement(k,o({ref:t},s))}));function k(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,o=new Array(i);o[0]=m;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l[c]="string"==typeof e?e:r,o[1]=l;for(var d=2;d<i;d++)o[d]=a[d];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},8304:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>d});var n=a(7462),r=(a(7294),a(3905));const i={},o="Container Maintenance",l={unversionedId:"guides/container",id:"guides/container",title:"Container Maintenance",description:"This document describes the entire structure of the RoboCup container definition as well as how to build it.",source:"@site/docs/guides/container.md",sourceDirName:"guides",slug:"/guides/container",permalink:"/docs/guides/container",draft:!1,editUrl:"https://github.com/lasr-at-home/base/blob/main/common/document_lasr/web/docs/guides/container.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"LASR Documentation",permalink:"/docs/"},next:{title:"Configuring Python dependencies for packages",permalink:"/docs/guides/virtualenv"}},p={},d=[{value:"Building",id:"building",level:2},{value:"Debugging build process",id:"debugging-build-process",level:3},{value:"Testing new dependencies",id:"testing-new-dependencies",level:3},{value:"Container",id:"container",level:2},{value:"Install packages from repositories",id:"install-packages-from-repositories",level:3},{value:"Install Python 3.10 from source",id:"install-python-310-from-source",level:3},{value:"Configure global Python installation",id:"configure-global-python-installation",level:3},{value:"Create overlay workspace for additional ROS packages",id:"create-overlay-workspace-for-additional-ros-packages",level:3},{value:"Perform clean up",id:"perform-clean-up",level:3}],s={toc:d},c="wrapper";function u(e){let{components:t,...a}=e;return(0,r.kt)(c,(0,n.Z)({},s,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"container-maintenance"},"Container Maintenance"),(0,r.kt)("p",null,"This document describes the entire structure of the RoboCup container definition as well as how to build it."),(0,r.kt)("h2",{id:"building"},"Building"),(0,r.kt)("p",null,"To build the container, ensure you have a copy of the TIAGo Melodic container and then proceed with:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"git clone https://github.com/lasr-at-home/containers.git ~/containers\ncd ~/containers\n\n# copy base container to tiago_pal_melodic.sif to current directory\n\nsudo apptainer build robocup_container.sif robocup_container.def\n")),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"This also works with the open source container.")),(0,r.kt)("h3",{id:"debugging-build-process"},"Debugging build process"),(0,r.kt)("p",null,"You can save a lot of time debugging build errors by redirecting all output to a file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"rm build.log 2>/dev/null; sudo apptainer build robocup_container.sif robocup_container.def 2>&1 | tee build.log\n")),(0,r.kt)("h3",{id:"testing-new-dependencies"},"Testing new dependencies"),(0,r.kt)("p",null,"If you'd like to test new dependencies without rebuilding the entire container, you can use the ",(0,r.kt)("inlineCode",{parentName:"p"},"stage2")," definition file."),(0,r.kt)("p",null,"After building the RoboCup container, you can then run:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sudo apptainer build stage2.sif stage2.def\n\n# .. with log:\nrm build.log 2>/dev/null; sudo apptainer build stage2.sif stage2.def 2>&1 | tee build.log\n")),(0,r.kt)("h2",{id:"container"},"Container"),(0,r.kt)("p",null,"This section goes over how the container is built."),(0,r.kt)("p",null,"We use the TIAGo Melodic container as a base which uses Ubuntu 18.04 as a base itself."),(0,r.kt)("h3",{id:"install-packages-from-repositories"},"Install packages from repositories"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Ensure the container is up to date by updating and upgrading from PAL apt repositories.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Install additional apt packages"),(0,r.kt)("table",{parentName:"li"},(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:"center"},"Package"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},"ros-melodic-audio-common"),(0,r.kt)("td",{parentName:"tr",align:null},"provides various ROS packages for capturing and playing back audio")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},"python3-numpy"),(0,r.kt)("td",{parentName:"tr",align:null},"numpy package for Python 3.6")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},"python3-opencv"),(0,r.kt)("td",{parentName:"tr",align:null},"cv2 package for Python 3.6")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},"libasound-dev",(0,r.kt)("br",null),"libportaudio2",(0,r.kt)("br",null),"libportaudiocpp0",(0,r.kt)("br",null),"portaudio19-dev"),(0,r.kt)("td",{parentName:"tr",align:null},"libraries required to build PyAudio wheel")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},"ffmpeg"),(0,r.kt)("td",{parentName:"tr",align:null},"record, convert, and stream audio / video")))),(0,r.kt)("admonition",{parentName:"li",type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Software packages on PAL repositories are quite old, there are situations where it is advisable to install software through alternative means."))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Install Node.js 16"),(0,r.kt)("p",{parentName:"li"},"All available distributions are ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/nodesource/distributions"},"listed here"),"."),(0,r.kt)("admonition",{parentName:"li",type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Node.js 16 is the latest that may be installed for Ubuntu 18.04. Their build system is currently broken for Node.js 18 and later. When upgrading to noetic, Node.js should be pinned to LTS."))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Install additional Python 3.6 packages"),(0,r.kt)("table",{parentName:"li"},(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:"center"},"Package"),(0,r.kt)("th",{parentName:"tr",align:"center"},"Version"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},"rosnumpy"),(0,r.kt)("td",{parentName:"tr",align:"center"},"0.0.5.2"),(0,r.kt)("td",{parentName:"tr",align:null},"conversion helper between ROS and numpy \u2020")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},"scipy"),(0,r.kt)("td",{parentName:"tr",align:"center"},"1.5.4"),(0,r.kt)("td",{parentName:"tr",align:null},"mathematics library")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},"black"),(0,r.kt)("td",{parentName:"tr",align:"center"},"22.8.0"),(0,r.kt)("td",{parentName:"tr",align:null},"Python code formatter")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},"scikit-build"),(0,r.kt)("td",{parentName:"tr",align:"center"},"0.16.7"),(0,r.kt)("td",{parentName:"tr",align:null},"build system for CPython C/C++/Fortran/Cython extensions using CMake")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},"scikit-learn"),(0,r.kt)("td",{parentName:"tr",align:"center"},"0.24.2"),(0,r.kt)("td",{parentName:"tr",align:null},"machine learning and data mining")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},"nvidia-ml-py3"),(0,r.kt)("td",{parentName:"tr",align:"center"},"7.352.0"),(0,r.kt)("td",{parentName:"tr",align:null},"bindings for NVIDIA Management Library")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},"torch"),(0,r.kt)("td",{parentName:"tr",align:"center"},"1.9.1+cpu"),(0,r.kt)("td",{parentName:"tr",align:null},"neural networks")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},"torchvision"),(0,r.kt)("td",{parentName:"tr",align:"center"},"0.10.1+cpu"),(0,r.kt)("td",{parentName:"tr",align:null},"torch extension for vision")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},"torchaudio"),(0,r.kt)("td",{parentName:"tr",align:"center"},"0.9.1"),(0,r.kt)("td",{parentName:"tr",align:null},"torch extension for audio")))),(0,r.kt)("p",{parentName:"li"},"\u2020 This library does not work on Python 3.10, ROS packages upgrading to newer Python versions must find a substitute."),(0,r.kt)("p",{parentName:"li"},"\u2021 Installed with CPU support only, ",(0,r.kt)("a",{parentName:"p",href:"https://pytorch.org/get-started/previous-versions/#linux-and-windows-17"},"see this page for more information"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Create a temporary ",(0,r.kt)("inlineCode",{parentName:"p"},"/deps")," folder which will be used to build additional dependencies in."))),(0,r.kt)("h3",{id:"install-python-310-from-source"},"Install Python 3.10 from source"),(0,r.kt)("p",null,"We install Python 3.10 to take advantage of modern Python libraries which no longer support Python 3.6, we can selectively choose to use it for some of our packages through the use of ",(0,r.kt)("a",{parentName:"p",href:"/guides/virtualenv"},"catkin virtualenv"),". This build step is derived from the ",(0,r.kt)("a",{parentName:"p",href:"https://devguide.python.org/getting-started/setup-building/"},"Python documentation"),"."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Install dependencies required for build."),(0,r.kt)("p",{parentName:"li"},"We choose to build all optional Python modules for maximum compatibility.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Download Python sources and extract.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Build Python sources and install globally."),(0,r.kt)("admonition",{parentName:"li",type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"This will override the global Python installation, this is cleaned up in a later build step."))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Install additional global packages."),(0,r.kt)("table",{parentName:"li"},(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:"center"},"Package"),(0,r.kt)("th",{parentName:"tr",align:"center"},"Version"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},"pyyaml"),(0,r.kt)("td",{parentName:"tr",align:"center"},"6.0.1"),(0,r.kt)("td",{parentName:"tr",align:null},"provides yaml package (required by rospy)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},"rospkg"),(0,r.kt)("td",{parentName:"tr",align:"center"},"1.5.0"),(0,r.kt)("td",{parentName:"tr",align:null},"environment agnostic ROS package utilities (required by rospy)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},"pip"),(0,r.kt)("td",{parentName:"tr",align:"center"},"23.2.1"),(0,r.kt)("td",{parentName:"tr",align:null},"Python package manager")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},"setuptools"),(0,r.kt)("td",{parentName:"tr",align:"center"},"68.0.0"),(0,r.kt)("td",{parentName:"tr",align:null},"Python build tools")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},"wheel"),(0,r.kt)("td",{parentName:"tr",align:"center"},"0.41.1"),(0,r.kt)("td",{parentName:"tr",align:null},"Python build tools")))))),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"We install from source as it's not available in PAL repositories and Python\nis no longer available from the deadsnakes PPA as Ubuntu 18.04 has lost support.\nWhen migrating this build step to noetic, you may be able to just use the\ndeadsnakes repository like:"),(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"apt install software-properties-common -y && apt-add-repository ppa:deadsnakes/ppa \\\n&& apt update && apt install python3.8 python3.8-dev python3-setuptools [.. etc]\n"))),(0,r.kt)("admonition",{type:"warning"},(0,r.kt)("p",{parentName:"admonition"},"Python 3.11+ is incompatible with rospy (Melodic & Noetic)")),(0,r.kt)("h3",{id:"configure-global-python-installation"},"Configure global Python installation"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Reconfigure Python symlinks"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"/usr/bin/python")," is made to point to Python 2.7"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"/usr/local/bin/python3")," is removed to restore Python 3.6 for ",(0,r.kt)("inlineCode",{parentName:"li"},"python3")))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Force catkin build tool to use Python 3.10"),(0,r.kt)("p",{parentName:"li"},"This step is necessary to get ",(0,r.kt)("inlineCode",{parentName:"p"},"catkin_virtualenv")," to work properly."),(0,r.kt)("p",{parentName:"li"},"We create a folder ",(0,r.kt)("inlineCode",{parentName:"p"},"/path/python3.10")," which contains a single symlink for ",(0,r.kt)("inlineCode",{parentName:"p"},"python3")," which we can then prepend to the PATH when invoking catkin."),(0,r.kt)("p",{parentName:"li"},"We only want to override ",(0,r.kt)("inlineCode",{parentName:"p"},"catkin build")," so this should be sufficient."))),(0,r.kt)("h3",{id:"create-overlay-workspace-for-additional-ros-packages"},"Create overlay workspace for additional ROS packages"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Create a new overlay workspace")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Clone ROS packages we want to build from source"),(0,r.kt)("table",{parentName:"li"},(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:"center"},"Package"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"),(0,r.kt)("th",{parentName:"tr",align:null},"Source"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},"catkin_virtualenv"),(0,r.kt)("td",{parentName:"tr",align:null},"Bundle python requirements in a catkin package via virtualenv"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("a",{parentName:"td",href:"https://github.com/locusrobotics/catkin_virtualenv"},"locusrobotics/catkin_virtualenv")," @ ",(0,r.kt)("inlineCode",{parentName:"td"},"4af9970")))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Build the workspace")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Add workspace setup to container environment"),(0,r.kt)("p",{parentName:"li"},"We hijack ",(0,r.kt)("inlineCode",{parentName:"p"},"/opt/env.sh")," and add our workspace at the end of the source chain."),(0,r.kt)("admonition",{parentName:"li",type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"This relies on the TIAGo PAL or open source containers being used as a base to detect where the line should be added.")))),(0,r.kt)("h3",{id:"perform-clean-up"},"Perform clean up"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Remove the build folder ",(0,r.kt)("inlineCode",{parentName:"p"},"/deps"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Remove extraneous environment variables"))))}u.isMDXComponent=!0}}]);